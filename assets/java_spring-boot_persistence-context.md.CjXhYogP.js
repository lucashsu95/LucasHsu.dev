import{_ as y,c as A,b as e,w as i,au as p,m as l,a as s,J as a,V as h,E as n,o as t}from"./chunks/framework.C9sE8QFS.js";const F=JSON.parse('{"title":"JPA æŒä¹…åŒ–ä¸Šä¸‹æ–‡ | LucasHsu.dev","description":"ç†è§£ JPA æŒä¹…åŒ–ä¸Šä¸‹æ–‡ï¼ˆPersistence Contextï¼‰èˆ‡å¯¦é«”ç”Ÿå‘½é€±æœŸï¼ŒæŒæ¡ Dirty Checking çš„é­”æ³•","frontmatter":{"title":"JPA æŒä¹…åŒ–ä¸Šä¸‹æ–‡ | LucasHsu.dev","description":"ç†è§£ JPA æŒä¹…åŒ–ä¸Šä¸‹æ–‡ï¼ˆPersistence Contextï¼‰èˆ‡å¯¦é«”ç”Ÿå‘½é€±æœŸï¼ŒæŒæ¡ Dirty Checking çš„é­”æ³•","head":[["meta",{"name":"keywords","content":"JPA, Persistence Context, Entity Lifecycle, Dirty Checking, EntityManager"}],["meta",{"property":"og:title","content":"JPA æŒä¹…åŒ–ä¸Šä¸‹æ–‡"}],["meta",{"property":"og:description","content":"ç†è§£ JPA æŒä¹…åŒ–ä¸Šä¸‹æ–‡èˆ‡å¯¦é«”ç”Ÿå‘½é€±æœŸ"}],["meta",{"property":"og:type","content":"article"}]]},"headers":[],"relativePath":"java/spring-boot/persistence-context.md","filePath":"java/spring-boot/persistence-context.md","lastUpdated":1770277310000}'),o={name:"java/spring-boot/persistence-context.md"},c=h('<h1 id="jpa-æŒä¹…åŒ–ä¸Šä¸‹æ–‡-entity-çš„äººç”Ÿå››éšæ®µ" tabindex="-1">JPA æŒä¹…åŒ–ä¸Šä¸‹æ–‡ï¼šEntity çš„äººç”Ÿå››éšæ®µ <a class="header-anchor" href="#jpa-æŒä¹…åŒ–ä¸Šä¸‹æ–‡-entity-çš„äººç”Ÿå››éšæ®µ" aria-label="Permalink to &quot;JPA æŒä¹…åŒ–ä¸Šä¸‹æ–‡ï¼šEntity çš„äººç”Ÿå››éšæ®µ&quot;">â€‹</a></h1><blockquote><p>ğŸ“ TL;DRï¼šæŒä¹…åŒ–ä¸Šä¸‹æ–‡å°±åƒæ˜¯<strong>è³‡æ–™åº«çš„è‰ç¨¿åŒ£</strong>â€”â€”Entity é€²å»å¾Œæœƒè¢«ç›£æ§ï¼Œä½ æ”¹äº†ä»€éº¼å®ƒéƒ½çŸ¥é“ï¼Œäº‹å‹™çµæŸæ™‚è‡ªå‹•å¹«ä½ å­˜ã€‚è¨˜ä½å››ç¨®ç‹€æ…‹ï¼š<strong>Transientï¼ˆè·¯äººï¼‰â†’ Managedï¼ˆå“¡å·¥ï¼‰â†’ Detachedï¼ˆé›¢è·ï¼‰â†’ Removedï¼ˆè¢«ç‚’ï¼‰</strong>ã€‚</p></blockquote><h2 id="å‰ç½®çŸ¥è­˜" tabindex="-1">å‰ç½®çŸ¥è­˜ <a class="header-anchor" href="#å‰ç½®çŸ¥è­˜" aria-label="Permalink to &quot;å‰ç½®çŸ¥è­˜&quot;">â€‹</a></h2><ul><li><strong>JPA åŸºç¤</strong> - çŸ¥é“ Entity æ˜¯ä»€éº¼</li><li><strong>è³‡æ–™åº«åŸºç¤</strong> - äº†è§£ CRUD æ“ä½œ</li></ul><h2 id="ä»€éº¼æ˜¯æŒä¹…åŒ–ä¸Šä¸‹æ–‡" tabindex="-1">ä»€éº¼æ˜¯æŒä¹…åŒ–ä¸Šä¸‹æ–‡ï¼Ÿ <a class="header-anchor" href="#ä»€éº¼æ˜¯æŒä¹…åŒ–ä¸Šä¸‹æ–‡" aria-label="Permalink to &quot;ä»€éº¼æ˜¯æŒä¹…åŒ–ä¸Šä¸‹æ–‡ï¼Ÿ&quot;">â€‹</a></h2><p>æƒ³åƒä½ åœ¨å…¬å¸å·¥ä½œï¼š</p><ul><li><strong>å…¬å¸</strong> = æŒä¹…åŒ–ä¸Šä¸‹æ–‡ï¼ˆPersistence Contextï¼‰</li><li><strong>ä½ </strong> = Entity</li><li><strong>HR ç³»çµ±</strong> = è³‡æ–™åº«</li></ul><p>æŒä¹…åŒ–ä¸Šä¸‹æ–‡å°±åƒæ˜¯<strong>å“¡å·¥ç®¡ç†ç³»çµ±</strong>â€”â€”å®ƒçŸ¥é“èª°é€²ä¾†äº†ã€èª°çš„è³‡æ–™è¢«æ”¹äº†ã€èª°è¦é›¢é–‹äº†ã€‚</p><h3 id="æ ¸å¿ƒæ¦‚å¿µåœ–" tabindex="-1">æ ¸å¿ƒæ¦‚å¿µåœ– <a class="header-anchor" href="#æ ¸å¿ƒæ¦‚å¿µåœ–" aria-label="Permalink to &quot;æ ¸å¿ƒæ¦‚å¿µåœ–&quot;">â€‹</a></h3>',9),D=h(`<h2 id="å¯¦é«”çš„ç”Ÿå‘½é€±æœŸ-entity-çš„äººç”Ÿå››éšæ®µ" tabindex="-1">å¯¦é«”çš„ç”Ÿå‘½é€±æœŸï¼šEntity çš„äººç”Ÿå››éšæ®µ <a class="header-anchor" href="#å¯¦é«”çš„ç”Ÿå‘½é€±æœŸ-entity-çš„äººç”Ÿå››éšæ®µ" aria-label="Permalink to &quot;å¯¦é«”çš„ç”Ÿå‘½é€±æœŸï¼šEntity çš„äººç”Ÿå››éšæ®µ&quot;">â€‹</a></h2><h3 id="_1-transient-ç¬æ™‚æ…‹-è·¯äººç”²" tabindex="-1">1. Transientï¼ˆç¬æ™‚æ…‹ï¼‰ï¼šè·¯äººç”² <a class="header-anchor" href="#_1-transient-ç¬æ™‚æ…‹-è·¯äººç”²" aria-label="Permalink to &quot;1. Transientï¼ˆç¬æ™‚æ…‹ï¼‰ï¼šè·¯äººç”²&quot;">â€‹</a></h3><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">User</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> user</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> new</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> User</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">();</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">  // å‰› new å‡ºä¾†</span></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">user</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">setName</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">å°æ˜</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">);</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">    // é‚„æ²’é€²å…¬å¸ï¼ˆè³‡æ–™åº«ï¼‰</span></span></code></pre></div><p><strong>ç‰¹å¾µï¼š</strong></p><ul><li>å‰› <code>new</code> å‡ºä¾†çš„ç‰©ä»¶</li><li>æ²’æœ‰ ID</li><li>è·Ÿè³‡æ–™åº«æ¯«ç„¡é—œä¿‚</li><li>å°±åƒé‚„æ²’æŠ•å±¥æ­·çš„æ±‚è·è€…</li></ul><h3 id="_2-managed-æŒä¹…åŒ–æ…‹-æ­£å¼å“¡å·¥-ğŸ‘”" tabindex="-1">2. Managedï¼ˆæŒä¹…åŒ–æ…‹ï¼‰ï¼šæ­£å¼å“¡å·¥ ğŸ‘” <a class="header-anchor" href="#_2-managed-æŒä¹…åŒ–æ…‹-æ­£å¼å“¡å·¥-ğŸ‘”" aria-label="Permalink to &quot;2. Managedï¼ˆæŒä¹…åŒ–æ…‹ï¼‰ï¼šæ­£å¼å“¡å·¥ ğŸ‘”&quot;">â€‹</a></h3><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">userRepository</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">save</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">user</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">);</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">  // é€²å…¥å…¬å¸åå†Š</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">// æˆ–è€…</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">User</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> user</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> userRepository</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">findById</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">1L</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">);</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">  // å¾å…¬å¸ç³»çµ±æ’ˆå‡ºä¾†</span></span></code></pre></div><p><strong>ç‰¹å¾µï¼š</strong></p><ul><li>åœ¨æŒä¹…åŒ–ä¸Šä¸‹æ–‡çš„ã€Œå“¡å·¥åå†Šã€è£¡</li><li>æœ‰ ID</li><li><strong>é‡é»ï¼šä½ æ”¹ä»€éº¼ï¼ŒHR ç³»çµ±éƒ½çŸ¥é“ï¼ˆDirty Checkingï¼‰</strong></li><li>äº‹å‹™çµæŸæ™‚ï¼Œè‡ªå‹•åŒæ­¥å›è³‡æ–™åº«</li></ul><div class="tip custom-block"><p class="custom-block-title">ğŸ’¡ Dirty Checking é­”æ³•</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">@</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">Transactional</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">public</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> void</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> updateUserName</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">Long id</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> String newName</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    User</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> user</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> userRepository</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">findById</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">id</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">).</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">get</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">();</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">  // Managed ç‹€æ…‹</span></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">    user</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">setName</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">newName</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">);</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">  // ç›´æ¥æ”¹</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">    // ä¸ç”¨å‘¼å« save()ï¼äº‹å‹™çµæŸæ™‚æœƒè‡ªå‹•å­˜</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">}</span></span></code></pre></div><p>é€™å°±åƒæ˜¯ï¼šä½ åœ¨å…¬å¸æ”¹äº†è‡ªå·±çš„è¯çµ¡è³‡æ–™ï¼Œä¸‹ç­æ™‚ HR ç³»çµ±æœƒè‡ªå‹•æ›´æ–°ï¼Œä¸ç”¨ç‰¹åˆ¥è·Ÿ HR èªªã€‚</p></div><h3 id="_3-detached-æ¸¸é›¢æ…‹-é›¢è·å“¡å·¥-ğŸ“¦" tabindex="-1">3. Detachedï¼ˆæ¸¸é›¢æ…‹ï¼‰ï¼šé›¢è·å“¡å·¥ ğŸ“¦ <a class="header-anchor" href="#_3-detached-æ¸¸é›¢æ…‹-é›¢è·å“¡å·¥-ğŸ“¦" aria-label="Permalink to &quot;3. Detachedï¼ˆæ¸¸é›¢æ…‹ï¼‰ï¼šé›¢è·å“¡å·¥ ğŸ“¦&quot;">â€‹</a></h3><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">// äº‹å‹™çµæŸå¾Œ...</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">// user é›¢é–‹æŒä¹…åŒ–ä¸Šä¸‹æ–‡ï¼Œè®Šæˆ Detached</span></span></code></pre></div><p><strong>ç‰¹å¾µï¼š</strong></p><ul><li>æ›¾ç¶“æ˜¯å“¡å·¥ï¼ˆæœ‰ IDï¼‰</li><li>ä½†å·²ç¶“é›¢è·ï¼ˆä¸åœ¨æŒä¹…åŒ–ä¸Šä¸‹æ–‡è£¡ï¼‰</li><li>æ”¹äº†ä¹Ÿä¸æœƒè‡ªå‹•å­˜â€”â€”ä½ å·²ç¶“ä¸æ˜¯æˆ‘å€‘çš„äººäº†</li></ul><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">// é›¢è·å¾Œåˆæƒ³å›ä¾†ï¼Ÿ</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">@</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">Transactional</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">public</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> void</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> rehire</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">User user</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">    userRepository</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">save</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">user</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">);</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">  // merge æ“ä½œï¼šé‡æ–°å…¥è·</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">}</span></span></code></pre></div><h3 id="_4-removed-ç§»é™¤æ…‹-è¢«é–‹é™¤" tabindex="-1">4. Removedï¼ˆç§»é™¤æ…‹ï¼‰ï¼šè¢«é–‹é™¤ <a class="header-anchor" href="#_4-removed-ç§»é™¤æ…‹-è¢«é–‹é™¤" aria-label="Permalink to &quot;4. Removedï¼ˆç§»é™¤æ…‹ï¼‰ï¼šè¢«é–‹é™¤&quot;">â€‹</a></h3><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">@</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">Transactional</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">public</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> void</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> fireUser</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">Long id</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    User</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> user</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> userRepository</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">findById</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">id</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">).</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">get</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">();</span></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">    userRepository</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">delete</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">user</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">);</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">  // æ¨™è¨˜ç‚º Removed</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">    // äº‹å‹™çµæŸæ™‚ï¼Œå¾è³‡æ–™åº«åˆªé™¤</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">}</span></span></code></pre></div><p><strong>ç‰¹å¾µï¼š</strong></p><ul><li>è¢«æ¨™è¨˜ç‚ºã€Œå¾…åˆªé™¤ã€</li><li>äº‹å‹™çµæŸå¾Œï¼Œè³‡æ–™åº«æœƒåŸ·è¡Œ DELETE</li></ul><h3 id="ç”Ÿå‘½é€±æœŸè½‰æ›åœ–" tabindex="-1">ç”Ÿå‘½é€±æœŸè½‰æ›åœ– <a class="header-anchor" href="#ç”Ÿå‘½é€±æœŸè½‰æ›åœ–" aria-label="Permalink to &quot;ç”Ÿå‘½é€±æœŸè½‰æ›åœ–&quot;">â€‹</a></h3>`,20),B=h(`<h2 id="é–‹å•ŸæŒä¹…åŒ–ä¸Šä¸‹æ–‡-ä¸‰ç¨®æ–¹å¼" tabindex="-1">é–‹å•ŸæŒä¹…åŒ–ä¸Šä¸‹æ–‡ï¼šä¸‰ç¨®æ–¹å¼ <a class="header-anchor" href="#é–‹å•ŸæŒä¹…åŒ–ä¸Šä¸‹æ–‡-ä¸‰ç¨®æ–¹å¼" aria-label="Permalink to &quot;é–‹å•ŸæŒä¹…åŒ–ä¸Šä¸‹æ–‡ï¼šä¸‰ç¨®æ–¹å¼&quot;">â€‹</a></h2><p>æŒä¹…åŒ–ä¸Šä¸‹æ–‡éœ€è¦è¢«ã€Œé–‹å•Ÿã€æ‰èƒ½é‹ä½œã€‚æœ‰ä¸‰ç¨®æ–¹å¼ï¼š</p><h3 id="_1-transactional-è¨»è§£-æœ€å¸¸ç”¨" tabindex="-1">1. <code>@Transactional</code> è¨»è§£ï¼ˆæœ€å¸¸ç”¨ï¼‰ <a class="header-anchor" href="#_1-transactional-è¨»è§£-æœ€å¸¸ç”¨" aria-label="Permalink to &quot;1. \`@Transactional\` è¨»è§£ï¼ˆæœ€å¸¸ç”¨ï¼‰&quot;">â€‹</a></h3><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">@</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">Service</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">public</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> class</span><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;"> UserService</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    </span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">    @</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">Transactional</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">  // é€²å…¥é€™å€‹æ–¹æ³•å°±é–‹å•ŸæŒä¹…åŒ–ä¸Šä¸‹æ–‡</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">    public</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> void</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> updateUser</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">Long </span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">id</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> String </span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">name</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">        User</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> user</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> userRepository</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">findById</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">id</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">).</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">get</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">();</span></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">        user</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">setName</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">name</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">);</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">  // Dirty Checking ç”Ÿæ•ˆ</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">    }</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">  // æ–¹æ³•çµæŸ â†’ flush â†’ commit â†’ ä¸Šä¸‹æ–‡é—œé–‰</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">}</span></span></code></pre></div><h3 id="_2-osiv-open-session-in-view" tabindex="-1">2. OSIVï¼ˆOpen Session In Viewï¼‰ <a class="header-anchor" href="#_2-osiv-open-session-in-view" aria-label="Permalink to &quot;2. OSIVï¼ˆOpen Session In Viewï¼‰&quot;">â€‹</a></h3><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">spring</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">  jpa</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">    open-in-view</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> true</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">  # è®“ Session æ´»åˆ° HTTP è«‹æ±‚çµæŸ</span></span></code></pre></div><p><strong>å„ªé»ï¼š</strong> Controller ä¹Ÿèƒ½å­˜å– Lazy å±¬æ€§ <strong>ç¼ºé»ï¼š</strong> è³‡æ–™åº«é€£ç·šæŒæœ‰å¤ªä¹…ï¼Œé«˜ä½µç™¼æœƒç‚¸</p><div class="warning custom-block"><p class="custom-block-title">âš ï¸ å°ˆæ¥­å»ºè­°</p><p>ç”Ÿç”¢ç’°å¢ƒå»ºè­°é—œæ‰ OSIVï¼Œåœ¨ Service å±¤ç”¨ <code>JOIN FETCH</code> æŠŠéœ€è¦çš„è³‡æ–™æŠ“å¥½ã€‚</p></div><h3 id="_3-å…¨åŸŸæ””æˆªå™¨-é€²éšç”¨æ³•" tabindex="-1">3. å…¨åŸŸæ””æˆªå™¨ï¼ˆé€²éšç”¨æ³•ï¼‰ <a class="header-anchor" href="#_3-å…¨åŸŸæ””æˆªå™¨-é€²éšç”¨æ³•" aria-label="Permalink to &quot;3. å…¨åŸŸæ””æˆªå™¨ï¼ˆé€²éšç”¨æ³•ï¼‰&quot;">â€‹</a></h3>`,9),E=l("code",null,"Config.java",-1),u=l("code",null,"TransactionInterceptor",-1),C=h(`<h2 id="å¯¦éš›ç¯„ä¾‹" tabindex="-1">å¯¦éš›ç¯„ä¾‹ <a class="header-anchor" href="#å¯¦éš›ç¯„ä¾‹" aria-label="Permalink to &quot;å¯¦éš›ç¯„ä¾‹&quot;">â€‹</a></h2><h3 id="ç¯„ä¾‹-1-dirty-checking-è‡ªå‹•æ›´æ–°" tabindex="-1">ç¯„ä¾‹ 1ï¼šDirty Checking è‡ªå‹•æ›´æ–° <a class="header-anchor" href="#ç¯„ä¾‹-1-dirty-checking-è‡ªå‹•æ›´æ–°" aria-label="Permalink to &quot;ç¯„ä¾‹ 1ï¼šDirty Checking è‡ªå‹•æ›´æ–°&quot;">â€‹</a></h3><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">@</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">Service</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">@</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">RequiredArgsConstructor</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">public</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> class</span><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;"> ProductService</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    </span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">    private</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> final</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> ProductRepository</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> productRepository</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    </span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">    @</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">Transactional</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">    public</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> void</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> applyDiscount</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">Long </span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">productId</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> int</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> discountPercent</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">        // 1. å¾è³‡æ–™åº«æ’ˆå‡ºä¾† â†’ Managed ç‹€æ…‹</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">        Product</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> product</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> productRepository</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">findById</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">productId</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">            .</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">orElseThrow</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(()</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> -&gt;</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> new</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> EntityNotFoundException</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">());</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">        </span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">        // 2. ç›´æ¥ä¿®æ”¹å±¬æ€§</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">        BigDecimal</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> originalPrice</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> product</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">getPrice</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">();</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">        BigDecimal</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> discount</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> originalPrice</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">multiply</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">            BigDecimal</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">valueOf</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">discountPercent </span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">/</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 100.0</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">        );</span></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">        product</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">setPrice</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">originalPrice</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">subtract</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">discount</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">));</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">        </span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">        // 3. ä¸ç”¨å‘¼å« save()ï¼</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">        // äº‹å‹™çµæŸæ™‚ï¼ŒJPA æœƒè‡ªå‹•æª¢æ¸¬åˆ° price è¢«æ”¹äº†</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">        // ç™¼å‡º UPDATE product SET price = ? WHERE id = ?</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">    }</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">}</span></span></code></pre></div><h3 id="ç¯„ä¾‹-2-detached-ç‹€æ…‹çš„è™•ç†" tabindex="-1">ç¯„ä¾‹ 2ï¼šDetached ç‹€æ…‹çš„è™•ç† <a class="header-anchor" href="#ç¯„ä¾‹-2-detached-ç‹€æ…‹çš„è™•ç†" aria-label="Permalink to &quot;ç¯„ä¾‹ 2ï¼šDetached ç‹€æ…‹çš„è™•ç†&quot;">â€‹</a></h3><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">@</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">RestController</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">@</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">RequiredArgsConstructor</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">public</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> class</span><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;"> UserController</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    </span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">    private</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> final</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> UserService</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> userService</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    </span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">    @</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">PutMapping</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">/users/{id}</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">    public</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> UserDTO </span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">updateUser</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(@</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">PathVariable</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> Long </span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">id</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> @</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">RequestBody</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> UserDTO </span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">dto</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">        // dto å¾ JSON ååºåˆ—åŒ–ä¾†çš„ï¼Œæ˜¯ Transient ç‹€æ…‹</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">        // ä½†å¦‚æœ dto æœ‰ idï¼Œæˆ‘å€‘è¦æŠŠå®ƒç•¶æˆ Detached ä¾†è™•ç†</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">        return</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> userService</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">updateUser</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">id</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> dto</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">);</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">    }</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">@</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">Service</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">@</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">RequiredArgsConstructor</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">public</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> class</span><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;"> UserService</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    </span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">    @</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">Transactional</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">    public</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> UserDTO </span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">updateUser</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">Long </span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">id</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> UserDTO </span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">dto</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">        // æ–¹æ³• 1ï¼šå…ˆæŸ¥å†æ”¹ï¼ˆæ¨è–¦ï¼‰</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">        User</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> user</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> userRepository</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">findById</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">id</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">            .</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">orElseThrow</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(()</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> -&gt;</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> new</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> EntityNotFoundException</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">());</span></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">        user</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">setName</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">dto</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">getName</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">());</span></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">        user</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">setEmail</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">dto</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">getEmail</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">());</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">        // Dirty Checking è‡ªå‹•è™•ç†</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">        </span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">        return</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> UserDTO</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">from</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">user</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">);</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">    }</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    </span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">    @</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">Transactional</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">    public</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> UserDTO </span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">updateUserV2</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">Long </span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">id</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> UserDTO </span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">dto</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">        // æ–¹æ³• 2ï¼šç›´æ¥ mergeï¼ˆä¸å¤ªæ¨è–¦ï¼‰</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">        User</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> user</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> new</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> User</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">();</span></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">        user</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">setId</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">id</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">);</span></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">        user</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">setName</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">dto</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">getName</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">());</span></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">        user</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">setEmail</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">dto</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">getEmail</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">());</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">        </span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">        User</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> merged</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> userRepository</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">save</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">user</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">);</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">  // merge æ“ä½œ</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">        // æ³¨æ„ï¼šå¦‚æœ dto æ²’çµ¦æŸå€‹æ¬„ä½ï¼Œé‚£å€‹æ¬„ä½æœƒè®Šæˆ nullï¼</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">        </span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">        return</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> UserDTO</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">from</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">merged</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">);</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">    }</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">}</span></span></code></pre></div><h2 id="å¸¸è¦‹å•é¡Œ-faq" tabindex="-1">å¸¸è¦‹å•é¡Œ FAQ <a class="header-anchor" href="#å¸¸è¦‹å•é¡Œ-faq" aria-label="Permalink to &quot;å¸¸è¦‹å•é¡Œ FAQ&quot;">â€‹</a></h2><h3 id="q1-ç‚ºä»€éº¼æˆ‘æ”¹äº†-entity-å»æ²’å­˜é€²è³‡æ–™åº«" tabindex="-1">Q1ï¼šç‚ºä»€éº¼æˆ‘æ”¹äº† Entity å»æ²’å­˜é€²è³‡æ–™åº«ï¼Ÿ <a class="header-anchor" href="#q1-ç‚ºä»€éº¼æˆ‘æ”¹äº†-entity-å»æ²’å­˜é€²è³‡æ–™åº«" aria-label="Permalink to &quot;Q1ï¼šç‚ºä»€éº¼æˆ‘æ”¹äº† Entity å»æ²’å­˜é€²è³‡æ–™åº«ï¼Ÿ&quot;">â€‹</a></h3><p><strong>å¯èƒ½åŸå› ï¼š</strong></p><ol><li>æ²’æœ‰ <code>@Transactional</code> â†’ æ²’æœ‰æŒä¹…åŒ–ä¸Šä¸‹æ–‡</li><li>Entity æ˜¯ Detached ç‹€æ…‹ï¼ˆäº‹å‹™å·²çµæŸï¼‰</li><li>æ–¹æ³•æ‹‹å‡º Exception â†’ äº‹å‹™å›æ»¾</li></ol><h3 id="q2-ä»€éº¼æ™‚å€™æœƒè§¸ç™¼-flush" tabindex="-1">Q2ï¼šä»€éº¼æ™‚å€™æœƒè§¸ç™¼ Flushï¼Ÿ <a class="header-anchor" href="#q2-ä»€éº¼æ™‚å€™æœƒè§¸ç™¼-flush" aria-label="Permalink to &quot;Q2ï¼šä»€éº¼æ™‚å€™æœƒè§¸ç™¼ Flushï¼Ÿ&quot;">â€‹</a></h3><ol><li>äº‹å‹™ <code>commit</code> å‰</li><li>æ‰‹å‹•å‘¼å« <code>entityManager.flush()</code></li><li>åŸ·è¡Œ JPQL æŸ¥è©¢å‰ï¼ˆç¢ºä¿æŸ¥åˆ°æœ€æ–°è³‡æ–™ï¼‰</li></ol><h3 id="q3-detached-entity-å¯ä»¥ç›´æ¥å­˜å—" tabindex="-1">Q3ï¼šDetached Entity å¯ä»¥ç›´æ¥å­˜å—ï¼Ÿ <a class="header-anchor" href="#q3-detached-entity-å¯ä»¥ç›´æ¥å­˜å—" aria-label="Permalink to &quot;Q3ï¼šDetached Entity å¯ä»¥ç›´æ¥å­˜å—ï¼Ÿ&quot;">â€‹</a></h3><p>å¯ä»¥ï¼Œç”¨ <code>save()</code> æœƒè§¸ç™¼ <code>merge</code> æ“ä½œã€‚ä½†è¦å°å¿ƒï¼šå¦‚æœæŸäº›æ¬„ä½æ²’è¨­å€¼ï¼Œæœƒè¢«å­˜æˆ <code>null</code>ï¼</p><h2 id="æœ€ä½³å¯¦è¸" tabindex="-1">æœ€ä½³å¯¦è¸ <a class="header-anchor" href="#æœ€ä½³å¯¦è¸" aria-label="Permalink to &quot;æœ€ä½³å¯¦è¸&quot;">â€‹</a></h2><h3 id="âœ…-æ¨è–¦åšæ³•" tabindex="-1">âœ… æ¨è–¦åšæ³• <a class="header-anchor" href="#âœ…-æ¨è–¦åšæ³•" aria-label="Permalink to &quot;âœ… æ¨è–¦åšæ³•&quot;">â€‹</a></h3><ol><li><strong>å–„ç”¨ Dirty Checking</strong> - ä¸ç”¨æ¯æ¬¡éƒ½å‘¼å« <code>save()</code></li><li><strong>äº‹å‹™é‚Šç•Œè¦æ¸…æ¥š</strong> - åœ¨ Service å±¤ä½¿ç”¨ <code>@Transactional</code></li><li><strong>å…ˆæŸ¥å†æ”¹</strong> - é¿å… merge è¦†è“‹å•é¡Œ</li></ol><h3 id="âŒ-å¸¸è¦‹éŒ¯èª¤" tabindex="-1">âŒ å¸¸è¦‹éŒ¯èª¤ <a class="header-anchor" href="#âŒ-å¸¸è¦‹éŒ¯èª¤" aria-label="Permalink to &quot;âŒ å¸¸è¦‹éŒ¯èª¤&quot;">â€‹</a></h3><ol><li><strong>å¿˜äº†åŠ  @Transactional</strong> - Entity è®Š Detached</li><li><strong>åœ¨ Controller æ”¹ Entity</strong> - äº‹å‹™å·²çµæŸï¼Œæ”¹äº†ä¹Ÿæ²’ç”¨</li><li><strong>æ··ç”¨ find + merge</strong> - å¯èƒ½ç”¢ç”Ÿé‡è¤‡è³‡æ–™</li></ol><h2 id="ç¸½çµ" tabindex="-1">ç¸½çµ <a class="header-anchor" href="#ç¸½çµ" aria-label="Permalink to &quot;ç¸½çµ&quot;">â€‹</a></h2><ol><li><strong>æŒä¹…åŒ–ä¸Šä¸‹æ–‡ = å“¡å·¥åå†Š</strong> - ç®¡ç† Entity çš„ç”Ÿå‘½é€±æœŸ</li><li><strong>å››ç¨®ç‹€æ…‹</strong> - Transient â†’ Managed â†’ Detached â†’ Removed</li><li><strong>Dirty Checking æ˜¯é­”æ³•</strong> - Managed ç‹€æ…‹çš„ Entity æœƒè‡ªå‹•åŒæ­¥</li><li><strong>äº‹å‹™ = ä¸Šä¸‹æ–‡çš„é‚Šç•Œ</strong> - é€²å…¥äº‹å‹™é–‹å•Ÿï¼Œé›¢é–‹äº‹å‹™é—œé–‰</li><li><strong>Detached è¦å°å¿ƒè™•ç†</strong> - ç”¨ merge æˆ–å…ˆæŸ¥å†æ”¹</li></ol>`,20);function v(m,b,_,P,T,q){const k=n("Mermaid"),r=n("VPNolebaseInlineLinkPreview"),d=n("NolebaseGitContributors"),g=n("NolebaseGitChangelog");return t(),A("div",null,[c,(t(),e(p,null,{default:i(()=>[a(k,{id:"mermaid-52",class:"mermaid",graph:"flowchart%20TB%0A%20%20%20%20subgraph%20PC%5B%22%E6%8C%81%E4%B9%85%E5%8C%96%E4%B8%8A%E4%B8%8B%E6%96%87%EF%BC%88EntityManager%20%E7%9A%84%E5%93%A1%E5%B7%A5%E5%90%8D%E5%86%8A%EF%BC%89%22%5D%0A%20%20%20%20%20%20%20%20direction%20TB%0A%20%20%20%20%20%20%20%20U%5B%22User%231%3Cbr%2F%3EManaged%22%5D%0A%20%20%20%20%20%20%20%20P%5B%22Post%235%3Cbr%2F%3EManaged%22%5D%0A%20%20%20%20%20%20%20%20O%5B%22Order%233%3Cbr%2F%3EManaged%22%5D%0A%20%20%20%20%20%20%20%20DC%5B%22%F0%9F%94%8D%20Dirty%20Checking%3Cbr%2F%3E%E8%80%81%E5%A4%A7%E5%9C%A8%E7%9B%A3%E8%A6%96%E4%BD%A0%E7%9A%84%E4%B8%80%E8%88%89%E4%B8%80%E5%8B%95%22%5D%0A%20%20%20%20%20%20%20%20FL%5B%22%F0%9F%92%BE%20Flush%3Cbr%2F%3E%E4%B8%8B%E7%8F%AD%E6%99%82%E6%8A%8A%E4%BD%A0%E4%BB%8A%E5%A4%A9%E7%9A%84%E5%B7%A5%E4%BD%9C%E6%88%90%E6%9E%9C%E5%AD%98%E6%AA%94%22%5D%0A%0A%20%20%20%20%20%20%20%20U%20---%20P%20---%20O%0A%20%20%20%20%20%20%20%20U%20--%3E%20DC%0A%20%20%20%20%20%20%20%20P%20--%3E%20DC%0A%20%20%20%20%20%20%20%20O%20--%3E%20DC%0A%20%20%20%20%20%20%20%20DC%20--%3E%20FL%0A%20%20%20%20end%0A"})]),fallback:i(()=>[s(" Loading... ")]),_:1})),D,(t(),e(p,null,{default:i(()=>[a(k,{id:"mermaid-167",class:"mermaid",graph:"flowchart%20TB%0A%20%20%20%20N%5B%22new%20User()%22%5D%20--%3E%20T%5B%22TRANSIENT%EF%BC%88%E8%B7%AF%E4%BA%BA%EF%BC%89%3Cbr%2F%3E%E9%82%84%E6%B2%92%E9%80%B2%E5%85%AC%E5%8F%B8%22%5D%0A%20%20%20%20T%20--%20%22persist()%20%2F%20save()%22%20--%3E%20M%5B%22MANAGED%EF%BC%88%E5%93%A1%E5%B7%A5%EF%BC%89%3Cbr%2F%3E%E5%9C%A8%E6%8C%81%E4%B9%85%E5%8C%96%E4%B8%8A%E4%B8%8B%E6%96%87%E8%A3%A1%22%5D%0A%20%20%20%20F%5B%22find()%20%2F%20getReference()%22%5D%20--%3E%20M%0A%20%20%20%20M%20--%20%22%E4%BA%8B%E5%8B%99%E7%B5%90%E6%9D%9F%20%2F%20entityManager.clear()%22%20--%3E%20D%5B%22DETACHED%EF%BC%88%E9%9B%A2%E8%81%B7%E5%93%A1%E5%B7%A5%EF%BC%89%3Cbr%2F%3E%E6%9C%89%20ID%EF%BC%8C%E4%BD%86%E4%B8%8D%E5%8F%97%E7%AE%A1%E7%90%86%22%5D%0A%20%20%20%20D%20--%20%22merge()%EF%BC%88%E9%87%8D%E6%96%B0%E5%85%A5%E8%81%B7%EF%BC%89%22%20--%3E%20M%0A%20%20%20%20M%20--%20%22remove()%22%20--%3E%20R%5B%22REMOVED%EF%BC%88%E8%A2%AB%E9%96%8B%E9%99%A4%EF%BC%89%3Cbr%2F%3E%E7%AD%89%E5%BE%85%20DELETE%22%5D%0A"})]),fallback:i(()=>[s(" Loading... ")]),_:1})),B,l("p",null,[s("å¯ä»¥åœ¨ "),E,s(" è£¡è¨­å®š "),u,s("ï¼Œæ ¹æ“šæ–¹æ³•åè‡ªå‹•æ±ºå®šäº‹å‹™è¡Œç‚ºã€‚è©³è¦‹ "),a(r,{href:"./transactional"},{default:i(()=>[s("@Transactional ç« ç¯€")]),_:1}),s("ã€‚")]),C,a(d),a(g)])}const x=y(o,[["render",v]]);export{F as __pageData,x as default};
